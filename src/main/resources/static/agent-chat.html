<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusMind æ™ºèƒ½ä½“å¯¹è¯</title>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --primary-dark: #5568d3;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 12px 30px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-icon {
            font-size: 28px;
            filter: drop-shadow(0 2px 4px rgba(102, 126, 234, 0.3));
        }

        .nav h1 {
            font-size: 1.4rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 60%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            letter-spacing: -0.5px;
            filter: drop-shadow(0 2px 4px rgba(102, 126, 234, 0.2));
        }

        .nav-links {
            display: flex;
            gap: 4px;
        }

        .nav-links a {
            margin-left: 6px;
            text-decoration: none;
            color: #555;
            font-weight: 600;
            padding: 10px 18px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            overflow: hidden;
        }

        .nav-links a::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 12px;
        }

        .nav-links a:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
        }

        .nav-links a:hover::before {
            opacity: 0.1;
        }

        .nav-links a.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            transform: translateY(-1px);
        }

        .nav-links a span {
            position: relative;
            z-index: 1;
        }

        .nav-auth {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .login-form {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .login-form input {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            width: 120px;
            outline: none;
            transition: border-color 0.3s;
        }

        .login-form input:focus {
            border-color: #667eea;
        }

        .login-form button {
            padding: 6px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: transform 0.2s;
        }

        .login-form button:hover {
            transform: scale(1.05);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .username {
            font-weight: 600;
            color: #667eea;
        }

        .logout-btn {
            padding: 6px 16px;
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #e8e8e8;
            color: #dc3545;
        }

        .chat-container {
            display: flex;
            flex: 1;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
            gap: 20px;
        }

        .sidebar {
            width: 300px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .sidebar-header h2 {
            font-size: 1.1rem;
            color: #333;
        }

        .new-chat-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .new-chat-btn:hover {
            background: #5568d3;
        }

        .conversation-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 12px 35px 12px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            margin-bottom: 5px;
            position: relative;
        }

        .conversation-item:hover {
            background: #f0f0f0;
        }

        .conversation-item:hover .conversation-delete-btn {
            display: block;
        }

        .conversation-item.active {
            background: #667eea;
            color: white;
        }

        .conversation-item.active .conversation-delete-btn {
            color: white;
        }

        .conversation-item.active .conversation-delete-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .conversation-title {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #333;
        }

        .conversation-item.active .conversation-title {
            color: white;
        }

        .conversation-delete-btn {
            display: none;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            padding: 2px 6px;
            border: none;
            background: rgba(240, 240, 240, 0.9);
            color: #666;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            border-radius: 4px;
            line-height: 1;
            transition: all 0.2s;
            z-index: 10;
        }

        .conversation-delete-btn:hover {
            background: #dc3545;
            color: white;
        }

        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chat-panel {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            font-size: 1.2rem;
            color: #333;
        }

        .chat-options {
            display: flex;
            gap: 15px;
        }

        .chat-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #555;
        }

        .chat-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 80%;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.user .message-avatar {
            display: none;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.assistant .message-avatar {
            background: white;
            border: 2px solid #e0e7ff;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .message-content {
            background: #f0f0f0;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            color: #333;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
        }

        .message-time {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .agent-execution-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-height: 250px;
            overflow-y: auto;
        }

        .agent-execution-panel h3 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: #667eea;
        }

        .agent-execution-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .agent-execution-item {
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            font-size: 13px;
        }

        .agent-execution-item.completed {
            border-left-color: #28a745;
        }

        .agent-execution-item.error {
            border-left-color: #dc3545;
        }

        .agent-execution-item .step {
            color: #667eea;
            font-weight: 600;
        }

        .agent-execution-item .agent-name {
            color: #333;
            font-weight: 600;
        }

        .agent-execution-item .status {
            color: #666;
            font-size: 12px;
        }

        .agent-execution-item .duration {
            color: #999;
            font-size: 11px;
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid #eee;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 24px;
            font-size: 15px;
            resize: none;
            outline: none;
            transition: border-color 0.3s;
            font-family: inherit;
            max-height: 120px;
        }

        #messageInput:focus {
            border-color: #667eea;
        }

        #sendBtn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s, transform 0.2s;
        }

        #sendBtn:hover:not(:disabled) {
            background: #5568d3;
            transform: scale(1.05);
        }

        #sendBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 5px;
            padding: 12px 16px;
            background: #f0f0f0;
            border-radius: 12px;
            max-width: 100px;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .welcome-message {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .welcome-message h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #333;
        }

        .welcome-message p {
            font-size: 14px;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 200px;
            }

            .message {
                max-width: 90%;
            }
        }

        /* KaTeX å…¬å¼æ ·å¼ */
        .katex {
            font-size: 1.1em;
        }

        .katex-display {
            margin: 1em 0;
            overflow-x: auto;
            overflow-y: hidden;
        }

        /* é‡‘èå…¬å¼å®¹å™¨ */
        .formula-container {
            background: #f8f9fa;
            border-left: 3px solid #667eea;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 6px;
        }

        .formula-container .formula-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .formula-inline {
            display: inline-block;
            padding: 2px 8px;
            background: #f0f0f0;
            border-radius: 4px;
            margin: 0 4px;
        }

        /* ç¾åŒ–é‡‘èç»“æœè¡¨æ ¼ */
        .financial-result {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #e0e0e0;
        }

        .financial-result h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .financial-result table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .financial-result td {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
        }

        .financial-result tr:last-child td {
            border-bottom: none;
        }

        .financial-result .label {
            font-weight: 600;
            color: #555;
        }

        .financial-result .value {
            color: #333;
            text-align: right;
        }

        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #17a2b8;
            padding: 12px 16px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.6;
        }

        /* æ–‡ä»¶ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        input[type="file"]::file-selector-button {
            cursor: pointer;
        }

        /* è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† */
        .confirm-dialog {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            padding: 20px;
            min-width: 280px;
            z-index: 10000;
            display: none;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -10px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .confirm-dialog.show {
            display: block;
        }

        .confirm-dialog-header {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .confirm-dialog-body {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .confirm-dialog-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .confirm-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .confirm-btn-cancel {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
        }

        .confirm-btn-cancel:hover {
            background: #e8e8e8;
        }

        .confirm-btn-delete {
            background: #dc3545;
            color: white;
            border: none;
        }

        .confirm-btn-delete:hover {
            background: #c82333;
        }

        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9999;
            display: none;
        }

        .confirm-overlay.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="nav">
        <div class="nav-left">
            <span class="nav-icon">âœ¨</span>
            <h1>NexusMind</h1>
        </div>
        <div class="nav-links">
            <a href="chat.html"><span>ğŸ’¬ æ™ºèƒ½é—®ç­”</span></a>
            <a href="agent-chat.html" class="active"><span>ğŸ¤– æ™ºèƒ½ä½“å¯¹è¯</span></a>
            <a href="domain.html"><span>ğŸ“š é¢†åŸŸæ–‡æ¡£</span></a>
            <a href="qdrant.html"><span>ğŸ—‚ï¸ å‘é‡ç®¡ç†</span></a>
        </div>
        <div class="nav-auth" id="authSection">
            <!-- æœªç™»å½•çŠ¶æ€ -->
            <div id="loginForm" class="login-form">
                <input type="text" id="username" placeholder="ç”¨æˆ·å" value="mark">
                <input type="password" id="password" placeholder="å¯†ç " value="mark">
                <button onclick="login()">ç™»å½•</button>
            </div>

            <!-- å·²ç™»å½•çŠ¶æ€ -->
            <div id="userInfo" class="user-info" style="display: none;">
                <span class="username"></span>
                <button class="logout-btn" onclick="logout()">é€€å‡º</button>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="confirm-overlay" id="confirmOverlay"></div>
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-dialog-header">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="2">
                <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <span>åˆ é™¤å¯¹è¯</span>
        </div>
        <div class="confirm-dialog-body">
            ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚
        </div>
        <div class="confirm-dialog-footer">
            <button class="confirm-btn confirm-btn-cancel" onclick="cancelDelete()">å–æ¶ˆ</button>
            <button class="confirm-btn confirm-btn-delete" onclick="confirmDelete()">åˆ é™¤</button>
        </div>
    </div>

    <div class="chat-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>å¯¹è¯å†å²</h2>
                <button class="new-chat-btn" onclick="newChat()">æ–°å»ºå¯¹è¯</button>
            </div>
            <div class="conversation-list" id="conversationList"></div>
        </div>

        <div class="main-chat">
            <div class="chat-panel">
                <div class="chat-header">
                    <h2 id="chatTitle">æ™ºèƒ½ä½“å¯¹è¯</h2>
                    <div class="chat-options">
                        <label class="chat-option">
                            <input type="checkbox" id="enableVectorStore" checked>
                            å‘é‡æ£€ç´¢
                        </label>
                        <label class="chat-option">
                            <input type="checkbox" id="enableMcp" checked>
                            MCPæ–‡ä»¶
                        </label>
                        <label class="chat-option">
                            <input type="checkbox" id="enableTools" checked>
                            å·¥å…·è°ƒç”¨
                        </label>
                    </div>
                </div>

                <!-- å¿«æ·æµ‹è¯•æŒ‰é’® -->
                <div style="padding: 10px 20px; border-bottom: 1px solid #eee; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="quickTest('calculation')" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e0e0e0; background: white; cursor: pointer; font-size: 12px;">ğŸ”¢ è®¡ç®—: 1+1</button>
                    <button onclick="quickTest('scientific')" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e0e0e0; background: white; cursor: pointer; font-size: 12px;">ğŸ“ ç§‘å­¦è®¡ç®—</button>
                    <button onclick="quickTest('irr')" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e0e0e0; background: white; cursor: pointer; font-size: 12px;">ğŸ“Š IRRè®¡ç®—</button>
                    <button onclick="quickTest('bond')" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e0e0e0; background: white; cursor: pointer; font-size: 12px;">ğŸ“Š å€ºåˆ¸ä»·æ ¼</button>
                    <button onclick="quickTest('option')" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e0e0e0; background: white; cursor: pointer; font-size: 12px;">ğŸ“ˆ æœŸæƒå®šä»·</button>
                    <button onclick="quickTest('amortization')" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e0e0e0; background: white; cursor: pointer; font-size: 12px;">ğŸ“‹ æ‘Šé”€è®¡åˆ’</button>
                    <button onclick="quickTest('weather')" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e0e0e0; background: white; cursor: pointer; font-size: 12px;">ğŸŒ¤ï¸ å¤©æ°”</button>
                    <button onclick="quickTest('time')" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e0e0e0; background: white; cursor: pointer; font-size: 12px;">ğŸ• æ—¶é—´</button>
                    <button onclick="quickTest('knowledge')" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e0e0e0; background: white; cursor: pointer; font-size: 12px;">ğŸ“š çŸ¥è¯†åº“</button>
                </div>

                <div class="messages" id="messages">
                    <div class="welcome-message" id="welcomeMessage">
                        <h3>æ¬¢è¿ä½¿ç”¨æ™ºèƒ½ä½“å¯¹è¯ç³»ç»Ÿ</h3>
                        <p>æ”¯æŒå¤šæ™ºèƒ½ä½“åä½œã€å‘é‡æ£€ç´¢ã€MCP æ–‡ä»¶æ“ä½œå’Œå·¥å…·è°ƒç”¨</p>
                    </div>
                </div>

                <!-- æ¶ˆæ¯é™„ä»¶é¢„è§ˆ -->
                <div id="attachmentPreview" style="display: none; padding: 10px 20px; border-top: 1px solid #eee;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 12px; color: #667eea;">ğŸ“</span>
                            <span id="attachmentName" style="font-size: 13px; color: #333;"></span>
                            <span id="attachmentSize" style="font-size: 11px; color: #999;"></span>
                        </div>
                        <button onclick="removeAttachment()" style="padding: 4px 8px; border: none; background: none; color: #dc3545; cursor: pointer; font-size: 16px;">Ã—</button>
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-wrapper">
                        <label for="fileAttachment" style="cursor: pointer; padding: 10px; display: flex; align-items: center; justify-content: center; color: #667eea; border-right: 1px solid #e0e0e0;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                            </svg>
                        </label>
                        <input type="file" id="fileAttachment" style="display: none;" accept=".txt,.pdf,.md,.doc,.docx">
                        <textarea id="messageInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜... Agent å°†è‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„å·¥å…·æ¥å›ç­”" rows="1"></textarea>
                        <button id="sendBtn" onclick="sendMessage()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="agent-execution-panel">
                <h3>âš¡ Agent æ‰§è¡Œè¿‡ç¨‹</h3>
                <div class="agent-execution-list" id="agentExecutionList">
                    <div style="color: #999; font-size: 13px; text-align: center;">
                        ç­‰å¾… Agent æ‰§è¡Œ...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentConversationId = null;
        let conversations = [];
        let agentExecutionHistory = [];
        let conversationTitles = {}; // å­˜å‚¨å¯¹è¯æ ‡é¢˜æ˜ å°„

        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const conversationList = document.getElementById('conversationList');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const chatTitle = document.getElementById('chatTitle');
        const agentExecutionList = document.getElementById('agentExecutionList');
        const enableVectorStore = document.getElementById('enableVectorStore');
        const enableMcp = document.getElementById('enableMcp');
        const enableTools = document.getElementById('enableTools');

        // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // å›è½¦å‘é€
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // åŠ è½½å¯¹è¯åˆ—è¡¨
        async function loadConversations() {
            try {
                const response = await fetch('/api/agent-chat/conversations', {
                    credentials: 'include'
                });

                // å¦‚æœè¿”å› 401ï¼Œè¯´æ˜æœªç™»å½•
                if (response.status === 401) {
                    showLoginForm();
                    return;
                }

                conversations = await response.json();

                // åŠ è½½æ¯ä¸ªå¯¹è¯çš„æ ‡é¢˜ï¼ˆç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼‰
                for (const convId of conversations) {
                    if (!conversationTitles[convId]) {
                        try {
                            const historyResponse = await fetch(`/api/agent-chat/history/${convId}`, {
                                credentials: 'include'
                            });
                            const messages = await historyResponse.json();
                            const firstUserMessage = messages.find(m => m.role === 'user');
                            if (firstUserMessage) {
                                conversationTitles[convId] = truncateTitle(firstUserMessage.content);
                            } else {
                                conversationTitles[convId] = 'æ–°å¯¹è¯';
                            }
                        } catch (e) {
                            conversationTitles[convId] = 'å¯¹è¯ ' + convId.substring(0, 8);
                        }
                    }
                }

                renderConversationList();
            } catch (error) {
                console.error('Failed to load conversations:', error);
            }
        }

        // æˆªæ–­æ ‡é¢˜
        function truncateTitle(title) {
            if (title.length > 15) {
                return title.substring(0, 15) + '...';
            }
            return title;
        }

        function renderConversationList() {
            conversationList.innerHTML = conversations.map(convId => `
                <div class="conversation-item ${convId === currentConversationId ? 'active' : ''}"
                     onclick="loadConversation('${convId}')">
                    <div class="conversation-title">${conversationTitles[convId] || 'åŠ è½½ä¸­...'}</div>
                    <button class="conversation-delete-btn"
                            onclick="deleteConversation('${convId}', event)"
                            title="åˆ é™¤å¯¹è¯">
                        Ã—
                    </button>
                </div>
            `).join('');
        }

        let conversationToDelete = null;

        async function deleteConversation(conversationId, event) {
            event.stopPropagation(); // é˜²æ­¢è§¦å‘loadConversation

            conversationToDelete = conversationId;

            // è·å–é¼ æ ‡ä½ç½®å’Œå¯¹è¯é¡¹ä½ç½®
            const rect = event.target.getBoundingClientRect();
            const dialog = document.getElementById('confirmDialog');
            const overlay = document.getElementById('confirmOverlay');

            // å®šä½å¯¹è¯æ¡†
            let left = rect.right + 10;
            let top = rect.top;

            // å¦‚æœå³ä¾§ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨å·¦ä¾§
            if (left + 280 > window.innerWidth) {
                left = rect.left - 290;
            }

            // å¦‚æœåº•éƒ¨ç©ºé—´ä¸å¤Ÿï¼Œå‘ä¸Šè°ƒæ•´
            if (top + 150 > window.innerHeight) {
                top = window.innerHeight - 160;
            }

            dialog.style.left = left + 'px';
            dialog.style.top = top + 'px';

            // æ˜¾ç¤ºå¯¹è¯æ¡†
            overlay.classList.add('show');
            dialog.classList.add('show');
        }

        async function confirmDelete() {
            if (!conversationToDelete) return;

            const conversationId = conversationToDelete;

            // éšè—å¯¹è¯æ¡†
            document.getElementById('confirmOverlay').classList.remove('show');
            document.getElementById('confirmDialog').classList.remove('show');
            conversationToDelete = null;

            try {
                const response = await fetch(`/api/agent-chat/conversations/${conversationId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    // ä»åˆ—è¡¨ä¸­ç§»é™¤
                    conversations = conversations.filter(id => id !== conversationId);
                    delete conversationTitles[conversationId];

                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œåˆ›å»ºæ–°å¯¹è¯
                    if (currentConversationId === conversationId) {
                        newChat();
                    } else {
                        renderConversationList();
                    }
                } else {
                    showError('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤å¯¹è¯å¤±è´¥:', error);
                showError('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        function cancelDelete() {
            // éšè—å¯¹è¯æ¡†
            document.getElementById('confirmOverlay').classList.remove('show');
            document.getElementById('confirmDialog').classList.remove('show');
            conversationToDelete = null;
        }

        function showError(message) {
            // ç®€å•çš„é”™è¯¯æç¤º
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #dc3545;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                z-index: 10001;
                font-size: 14px;
                font-weight: 500;
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);

            setTimeout(() => {
                errorDiv.remove();
            }, 2000);
        }

        function newChat() {
            currentConversationId = null;
            chatTitle.textContent = 'æ™ºèƒ½ä½“å¯¹è¯';
            messagesContainer.innerHTML = `
                <div class="welcome-message">
                    <h3>æ¬¢è¿ä½¿ç”¨æ™ºèƒ½ä½“å¯¹è¯ç³»ç»Ÿ</h3>
                    <p>æ”¯æŒå¤šæ™ºèƒ½ä½“åä½œã€å‘é‡æ£€ç´¢ã€MCP æ–‡ä»¶æ“ä½œå’Œå·¥å…·è°ƒç”¨</p>
                </div>
            `;
            agentExecutionList.innerHTML = `
                <div style="color: #999; font-size: 13px; text-align: center;">
                    ç­‰å¾… Agent æ‰§è¡Œ...
                </div>
            `;
            agentExecutionHistory = [];
            renderConversationList();
        }

        async function loadConversation(conversationId) {
            try {
                currentConversationId = conversationId;

                const response = await fetch(`/api/agent-chat/history/${conversationId}`, {
                    credentials: 'include'
                });
                const messages = await response.json();

                // æå–ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
                const firstUserMessage = messages.find(m => m.role === 'user');
                if (firstUserMessage && !conversationTitles[conversationId]) {
                    conversationTitles[conversationId] = truncateTitle(firstUserMessage.content);
                }

                // é¡µé¢æ ‡é¢˜æ˜¾ç¤ºå¯¹è¯ID
                chatTitle.textContent = `${conversationTitles[conversationId] || 'å¯¹è¯'} (${conversationId.substring(0, 8)})`;

                messagesContainer.innerHTML = '';
                messages.forEach(msg => {
                    appendMessage(msg.role, msg.content, msg.createdAt);
                });

                // åŠ è½½ Agent æ‰§è¡Œå†å²
                const historyResponse = await fetch('/api/agent-chat/agent-execution-history');
                agentExecutionHistory = await historyResponse.json();
                renderAgentExecutionHistory();

                renderConversationList();
            } catch (error) {
                console.error('Failed to load conversation:', error);
            }
        }

        async function sendMessage() {
            // æ£€æŸ¥æ˜¯å¦ç™»å½•
            const authCheck = await fetch('/api/auth/check-auth').then(r => r.json());
            if (!authCheck.success) {
                showError('è¯·å…ˆç™»å½•');
                return;
            }

            const question = messageInput.value.trim();
            if (!question) return;

            messageInput.value = '';
            messageInput.style.height = 'auto';

            welcomeMessage.style.display = 'none';

            // å¦‚æœæœ‰é™„ä»¶ï¼Œå…ˆä¸Šä¼ æ–‡ä»¶
            let filePath = null;
            if (messageAttachment) {
                try {
                    const formData = new FormData();
                    formData.append('file', messageAttachment);
                    if (currentConversationId) {
                        formData.append('conversationId', currentConversationId);
                    }

                    const uploadResponse = await fetch('/api/agent-files/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const uploadResult = await uploadResponse.json();
                    if (uploadResult.success) {
                        filePath = uploadResult.filePath;
                    } else {
                        appendMessage('assistant', 'âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + uploadResult.message);
                        return;
                    }
                } catch (error) {
                    appendMessage('assistant', 'âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message);
                    return;
                }
            }

            // æ„å»ºæœ€ç»ˆæ¶ˆæ¯ï¼Œå¦‚æœæœ‰æ–‡ä»¶é™„ä»¶åˆ™å‘ŠçŸ¥LLM
            let finalMessage = question;
            if (filePath) {
                // æå–ç›¸å¯¹è·¯å¾„ï¼ˆä»uploadså¼€å§‹ï¼‰
                const relativePath = filePath.includes('/uploads/') ? filePath.split('/uploads/')[1] : filePath;
                finalMessage = `${question}\n\n[ç”¨æˆ·å·²ä¸Šä¼ æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨MCPæ–‡ä»¶å·¥å…·readFileè¯»å–å¹¶åˆ†æ: uploads/${relativePath}]`;
            }

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            let displayMessage = question;
            if (messageAttachment) {
                displayMessage = `ğŸ“ æ–‡ä»¶: ${messageAttachment.name}\n\n${question}`;
            }
            appendMessage('user', displayMessage);

            // æ¸…é™¤é™„ä»¶
            if (filePath) {
                removeAttachment();
            }

            // ä¿å­˜å½“å‰é—®é¢˜ä½œä¸ºå¯¹è¯æ ‡é¢˜
            if (!currentConversationId && question) {
                const tempId = 'temp_' + Date.now();
                conversationTitles[tempId] = truncateTitle(question);
            }

            sendBtn.disabled = true;

            // åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å ä½ç¬¦
            const assistantMessageDiv = createMessageElement('assistant', '');
            messagesContainer.appendChild(assistantMessageDiv);
            const messageContent = assistantMessageDiv.querySelector('.message-content');

            // æ·»åŠ è¾“å…¥æŒ‡ç¤ºå™¨
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator active';
            typingIndicator.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            messageContent.appendChild(typingIndicator);

            // æ¸…ç©ºå¹¶å‡†å¤‡æ˜¾ç¤º Agent æ‰§è¡Œå†å²
            agentExecutionHistory = [];
            agentExecutionList.innerHTML = '<div style="color: #667eea; font-size: 13px; text-align: center;">ğŸ”„ Agent æ‰§è¡Œä¸­...</div>';

            try {
                const response = await fetch('/api/agent-chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',  // é‡è¦ï¼šåŒ…å«Session cookie
                    body: JSON.stringify({
                        message: finalMessage,
                        conversationId: currentConversationId || null,
                        enableVectorStore: enableVectorStore.checked,
                        enableMcp: enableMcp.checked,
                        enableTools: enableTools.checked
                    })
                });

                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';

                // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
                typingIndicator.remove();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    let currentEvent = null;

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i];
                        const trimmedLine = line.trim();

                        if (!trimmedLine) continue;

                        // SSE æ ¼å¼è§£æ - event:åé¢å¯èƒ½æœ‰ç©ºæ ¼ä¹Ÿå¯èƒ½æ²¡æœ‰
                        if (trimmedLine.startsWith('event:')) {
                            currentEvent = trimmedLine.substring(6).trim();
                        } else if (trimmedLine.startsWith('data:')) {
                            const data = trimmedLine.substring(5).trim(); // data: æ˜¯5ä¸ªå­—ç¬¦

                            // æ ¹æ® event ç±»å‹å¤„ç†
                            if (currentEvent === 'message') {
                                fullResponse += data;
                                // æµå¼è¾“å‡ºæ—¶ä½¿ç”¨ textContentï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
                                messageContent.textContent = fullResponse;
                                scrollToBottom();
                            } else if (currentEvent === 'agent-history') {
                                try {
                                    agentExecutionHistory = JSON.parse(data);
                                    renderAgentExecutionHistory();
                                } catch (e) {
                                    console.error('Failed to parse agent history:', data, e);
                                }
                            } else if (currentEvent === 'done') {
                                currentConversationId = data;
                                loadConversations();
                            }
                        }
                    }
                }

                // æµå¼è¾“å‡ºç»“æŸåï¼Œå»¶è¿Ÿä¸€ä¸‹å†æ¸²æŸ“ KaTeX å…¬å¼ï¼ˆç¡®ä¿å®Œæ•´çš„å…¬å¼ï¼‰
                setTimeout(() => {
                    messageContent.innerHTML = renderMathFormulas(fullResponse);
                    scrollToBottom();
                }, 100);

                // æ·»åŠ æ—¶é—´æˆ³
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date().toLocaleTimeString();
                assistantMessageDiv.appendChild(timeDiv);

            } catch (error) {
                console.error('Chat error:', error);
                messageContent.textContent = 'æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ã€‚è¯·ç¨åé‡è¯•ã€‚';
                agentExecutionList.innerHTML = `
                    <div style="color: #dc3545; font-size: 13px; text-align: center;">
                        âŒ æ‰§è¡Œå¤±è´¥: ${error.message}
                    </div>
                `;
            } finally {
                sendBtn.disabled = false;
            }
        }

        function appendMessage(role, content, time = null) {
            const messageDiv = createMessageElement(role, content);
            if (time) {
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date(time).toLocaleString();
                messageDiv.appendChild(timeDiv);
            }
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function createMessageElement(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';

            if (role === 'assistant') {
                // AI åŠ©æ‰‹ä½¿ç”¨æœºå™¨äººå›¾æ ‡
                avatar.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- æœºå™¨äººå¤´éƒ¨ -->
                        <rect x="4" y="6" width="16" height="12" rx="2" fill="#667eea"/>
                        <!-- å¤©çº¿ -->
                        <line x1="12" y1="6" x2="12" y2="3" stroke="#667eea" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="12" cy="2" r="1.5" fill="#667eea"/>
                        <!-- çœ¼ç› -->
                        <circle cx="8" cy="11" r="1.5" fill="white"/>
                        <circle cx="16" cy="11" r="1.5" fill="white"/>
                        <!-- å˜´å·´ -->
                        <rect x="9" y="14" width="6" height="1.5" rx="0.75" fill="white"/>
                        <!-- è€³æœµ -->
                        <rect x="2" y="9" width="2" height="4" rx="1" fill="#667eea"/>
                        <rect x="20" y="9" width="2" height="4" rx="1" fill="#667eea"/>
                    </svg>
                `;
            }

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            // æ¸²æŸ“ LaTeX å…¬å¼
            messageContent.innerHTML = renderMathFormulas(content);

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);

            return messageDiv;
        }

        // æ¸²æŸ“æ•°å­¦å…¬å¼å’Œ Markdown
        function renderMathFormulas(text) {
            if (typeof text !== 'string') return text;

            // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥å…¬å¼æ˜¯å¦å®Œæ•´
            function isFormulaComplete(formula) {
                const trimmed = formula.trim();
                // æ£€æŸ¥æ˜¯å¦æœ‰æ˜æ˜¾çš„æˆªæ–­è¿¹è±¡
                if (trimmed.endsWith('.') || trimmed.endsWith(',') ||
                    trimmed.endsWith('+') || trimmed.endsWith('-') ||
                    trimmed.endsWith('=') || trimmed.endsWith('\\') ||
                    trimmed.endsWith('(') || trimmed.endsWith('{')) {
                    return false;
                }
                // æ£€æŸ¥æ‹¬å·æ˜¯å¦å¹³è¡¡
                const openParens = (trimmed.match(/\(/g) || []).length;
                const closeParens = (trimmed.match(/\)/g) || []).length;
                const openBraces = (trimmed.match(/\{/g) || []).length;
                const closeBraces = (trimmed.match(/\}/g) || []).length;
                const openBrackets = (trimmed.match(/\[/g) || []).length;
                const closeBrackets = (trimmed.match(/\]/g) || []).length;

                return openParens === closeParens &&
                       openBraces === closeBraces &&
                       openBrackets === closeBrackets;
            }

            // 1. å…ˆæ¸²æŸ“ LaTeX æ ‡å‡†æ ¼å¼å—çº§å…¬å¼ \[...\]
            text = text.replace(/\\\[([\s\S]*?)\\\]/g, (match, formula) => {
                try {
                    if (!isFormulaComplete(formula)) {
                        return match; // ä¸å®Œæ•´çš„å…¬å¼ä¿æŒåŸæ ·
                    }
                    return '<div class="katex-display" style="margin: 15px 0; text-align: center; overflow-x: auto; overflow-y: hidden;">' +
                           katex.renderToString(formula.trim(), { displayMode: true }) +
                           '</div>';
                } catch (e) {
                    console.error('KaTeX render error:', e, formula);
                    return match;
                }
            });

            // 2. æ¸²æŸ“ LaTeX æ ‡å‡†æ ¼å¼è¡Œå†…å…¬å¼ \(......\)
            text = text.replace(/\\\(([^)]*?)\\\)/g, (match, formula) => {
                try {
                    if (!isFormulaComplete(formula)) {
                        return match;
                    }
                    return katex.renderToString(formula.trim(), { displayMode: false });
                } catch (e) {
                    console.error('KaTeX render error:', e, formula);
                    return match;
                }
            });

            // 3. æ¸²æŸ“å—çº§å…¬å¼ $$...$$ï¼ˆé¿å…è¢« Markdown å¤„ç†ï¼‰
            text = text.replace(/\$\$([^$]+)\$\$/g, (match, formula) => {
                try {
                    if (!isFormulaComplete(formula)) {
                        return match;
                    }
                    return '<div class="katex-display" style="margin: 15px 0; text-align: center; overflow-x: auto; overflow-y: hidden;">' +
                           katex.renderToString(formula.trim(), { displayMode: true }) +
                           '</div>';
                } catch (e) {
                    console.error('KaTeX render error:', e, formula);
                    return match;
                }
            });

            // 4. æ¸²æŸ“è¡Œå†…å…¬å¼ $...$
            text = text.replace(/\$([^$]+)\$/g, (match, formula) => {
                try {
                    if (!isFormulaComplete(formula)) {
                        return match;
                    }
                    return katex.renderToString(formula.trim(), { displayMode: false });
                } catch (e) {
                    console.error('KaTeX render error:', e, formula);
                    return match;
                }
            });

            // 5. å¤„ç† Markdown æ ‡é¢˜ ## å’Œ ###
            text = text.replace(/^### (.+)$/gm, '<h4 style="margin: 15px 0 10px 0; color: #667eea; font-size: 1.1em;">$1</h4>');
            text = text.replace(/^## (.+)$/gm, '<h3 style="margin: 20px 0 15px 0; color: #667eea; font-size: 1.3em;">$1</h3>');

            // 6. å¤„ç†åŠ ç²— **text**
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

            // 7. å¤„ç†æ— åºåˆ—è¡¨ - å¼€å¤´
            text = text.replace(/^- (.+)$/gm, '<li style="margin: 5px 0 5px 20px;">$1</li>');

            // 8. å¤„ç†è¿ç»­çš„ liï¼ŒåŒ…è£¹åœ¨ ul ä¸­
            text = text.replace(/(<li[^>]*>.*<\/li>\n?)+/g, (match) => {
                return '<ul style="margin: 10px 0; padding-left: 20px;">' + match + '</ul>';
            });

            // 9. å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br>ï¼ˆä½†ä¸åœ¨ HTML æ ‡ç­¾ä¸­ï¼‰
            text = text.replace(/\n(?![^<]*>)/g, '<br>');

            return text;
        }

        function renderAgentExecutionHistory() {
            if (agentExecutionHistory.length === 0) {
                agentExecutionList.innerHTML = `
                    <div style="color: #999; font-size: 13px; text-align: center;">
                        ç­‰å¾… Agent æ‰§è¡Œ...
                    </div>
                `;
                return;
            }

            agentExecutionList.innerHTML = agentExecutionHistory.map(item => `
                <div class="agent-execution-item ${item.status.toLowerCase()}">
                    <div>
                        <span class="step">æ­¥éª¤ ${item.step}</span>
                        <span class="agent-name">${getAgentDisplayName(item.agentName)}</span>
                    </div>
                    <div class="status">çŠ¶æ€: ${getStatusText(item.status)}</div>
                    ${item.duration ? `<div class="duration">è€—æ—¶: ${item.duration}ms</div>` : ''}
                    ${item.output ? `<div style="margin-top: 5px; color: #666; font-size: 12px;">${truncateOutput(item.output)}</div>` : ''}
                </div>
            `).join('');
        }

        function getAgentDisplayName(agentName) {
            const displayNames = {
                'RequestClassifier': 'è¯·æ±‚åˆ†ç±»å™¨',
                'Calculator': 'è®¡ç®—å™¨ (exp4j)',
                'ScientificCalculator': 'ç§‘å­¦è®¡ç®—å™¨',
                'WeatherService': 'å¤©æ°”æœåŠ¡',
                'TimeService': 'æ—¶é—´æœåŠ¡',
                'VectorStore': 'å‘é‡æ£€ç´¢',
                'GeneralChat': 'é€šç”¨å¯¹è¯',
                'Enhanced_LLM_Agent': 'å¢å¼ºå‹AI',
                'LLM_Agent': 'AIåŠ©æ‰‹',
                'ToolExecution': 'å·¥å…·æ‰§è¡Œ',
                'UnitConverter': 'å•ä½è½¬æ¢'
            };
            return displayNames[agentName] || agentName;
        }

        function getStatusText(status) {
            const statusTexts = {
                'STARTED': 'ğŸ”„ æ‰§è¡Œä¸­',
                'COMPLETED': 'âœ… å®Œæˆ',
                'ERROR': 'âŒ å¤±è´¥'
            };
            return statusTexts[status] || status;
        }

        function truncateOutput(output) {
            if (!output) return '';
            return output.length > 100 ? output.substring(0, 100) + '...' : output;
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ========== æ¶ˆæ¯é™„ä»¶åŠŸèƒ½ ==========
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // ========== æ¶ˆæ¯é™„ä»¶åŠŸèƒ½ ==========
        let messageAttachment = null;
        const fileAttachment = document.getElementById('fileAttachment');
        const attachmentPreview = document.getElementById('attachmentPreview');
        const attachmentName = document.getElementById('attachmentName');
        const attachmentSize = document.getElementById('attachmentSize');

        // æ–‡ä»¶é™„ä»¶é€‰æ‹©ç›‘å¬
        fileAttachment.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // æ˜¾ç¤ºé™„ä»¶é¢„è§ˆ
            messageAttachment = file;
            attachmentName.textContent = file.name;
            attachmentSize.textContent = formatFileSize(file.size);
            attachmentPreview.style.display = 'block';

            // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            fileAttachment.value = '';
        });

        // ç§»é™¤é™„ä»¶
        function removeAttachment() {
            messageAttachment = null;
            attachmentPreview.style.display = 'none';
        }

        // ========== é¡µé¢ç‰¹å®šçš„è®¤è¯å›è°ƒ ==========
        window.onShowUserInfo = function(username) {
            loadConversations();
        };

        window.onShowLoginForm = function() {
            conversationList.innerHTML = '<div style="color: #999; font-size: 13px; text-align: center; padding: 20px;">è¯·å…ˆç™»å½•</div>';
        };

        // å¿«æ·æµ‹è¯•åŠŸèƒ½
        async function quickTest(type) {
            const questions = {
                'calculation': '1 + 1 ç­‰äºå¤šå°‘ï¼Ÿ',
                'scientific': 'sin(30) + cos(60) ç­‰äºå¤šå°‘ï¼Ÿ',
                'irr': 'æŠ•èµ„é¡¹ç›®åˆå§‹æŠ•èµ„10000å…ƒï¼Œæœªæ¥5å¹´æ¯å¹´æ”¶ç›Š2500å…ƒï¼Œè®¡ç®—å†…éƒ¨æ”¶ç›Šç‡IRR',
                'bond': 'é¢å€¼1000å…ƒçš„å€ºåˆ¸ï¼Œç¥¨é¢åˆ©ç‡5%ï¼Œåˆ°æœŸæ”¶ç›Šç‡4%ï¼Œ5å¹´æœŸï¼ŒåŠå¹´ä»˜æ¯ä¸€æ¬¡ï¼Œè®¡ç®—å€ºåˆ¸ä»·æ ¼',
                'option': 'ä½¿ç”¨Black-Scholesæ¨¡å‹è®¡ç®—çœ‹æ¶¨æœŸæƒä»·æ ¼ï¼šæ ‡çš„ä»·æ ¼100å…ƒï¼Œè¡Œæƒä»·105å…ƒï¼Œ1å¹´æœŸï¼Œæ— é£é™©åˆ©ç‡3%ï¼Œæ³¢åŠ¨ç‡25%',
                'amortization': 'æœ¬é‡‘100000å…ƒï¼Œå¹´åˆ©ç‡5%ï¼Œ10å¹´æœŸï¼Œæ¯æœˆç­‰é¢æœ¬æ¯è¿˜æ¬¾ï¼Œè®¡ç®—æ‘Šé”€è®¡åˆ’',
                'weather': 'è‹å·ä»Šå¤©çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ',
                'time': 'ç°åœ¨å‡ ç‚¹äº†ï¼Ÿ',
                'knowledge': 'ä¸‰å›½æ¼”ä¹‰ä¸­åˆ˜å¤‡æœ‰å“ªäº›å…„å¼Ÿï¼Ÿ'
            };

            messageInput.value = questions[type];
            sendMessage();
        }
    </script>

    <!-- å¼•å…¥è®¤è¯ç®¡ç†è„šæœ¬ -->
    <script src="/js/auth.js"></script>

    <!-- KaTeX JS - ä¸ä½¿ç”¨ deferï¼Œç¡®ä¿ç«‹å³åŠ è½½ -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
</body>
</html>
